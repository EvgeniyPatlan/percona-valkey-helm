{{- include "percona-valkey.validateValues" . -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "percona-valkey.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "percona-valkey.labels" . | nindent 4 }}
data:
  valkey.conf: |
    protected-mode no
    port 6379
    dir /data
    {{- if .Values.config.bind }}
    bind {{ .Values.config.bind }}
    {{- end }}
    {{- if .Values.config.maxmemory }}
    maxmemory {{ .Values.config.maxmemory }}
    {{- end }}
    {{- if .Values.config.maxmemoryPolicy }}
    maxmemory-policy {{ .Values.config.maxmemoryPolicy }}
    {{- end }}
    # RDB persistence
    save 3600 1 300 100 60 10000
    dbfilename dump.rdb
    # AOF persistence
    appendonly yes
    appendfilename "appendonly.aof"
    {{- if .Values.tls.enabled }}
    # TLS configuration
    tls-port {{ .Values.tls.port }}
    tls-cert-file {{ .Values.tls.certMountPath }}/tls.crt
    tls-key-file {{ .Values.tls.certMountPath }}/tls.key
    tls-ca-cert-file {{ .Values.tls.certMountPath }}/ca.crt
    tls-auth-clients {{ .Values.tls.authClients }}
    {{- if .Values.tls.disablePlaintext }}
    port 0
    {{- end }}
    {{- if .Values.tls.replication }}
    tls-replication yes
    {{- end }}
    {{- if .Values.tls.ciphers }}
    tls-ciphers {{ .Values.tls.ciphers }}
    {{- end }}
    {{- if .Values.tls.ciphersuites }}
    tls-ciphersuites {{ .Values.tls.ciphersuites }}
    {{- end }}
    {{- end }}
    {{- if eq .Values.mode "cluster" }}
    # Cluster settings
    cluster-enabled yes
    cluster-config-file /data/nodes.conf
    cluster-node-timeout {{ .Values.cluster.nodeTimeout }}
    {{- if .Values.tls.enabled }}
    tls-cluster yes
    {{- end }}
    {{- end }}
    {{- if and (eq .Values.mode "sentinel") .Values.tls.enabled }}
    tls-replication yes
    {{- end }}
    {{- $cmds := .Values.disableCommands }}
    {{- if and (eq .Values.mode "standalone") .Values.disableCommandsStandalone }}
    {{- $cmds = .Values.disableCommandsStandalone }}
    {{- else if and (eq .Values.mode "cluster") .Values.disableCommandsCluster }}
    {{- $cmds = .Values.disableCommandsCluster }}
    {{- else if and (eq .Values.mode "sentinel") .Values.disableCommandsSentinel }}
    {{- $cmds = .Values.disableCommandsSentinel }}
    {{- end }}
    {{- if .Values.acl.enabled }}
    # ACL configuration
    aclfile /etc/valkey/acl/users.acl
    {{- end }}
    {{- if $cmds }}
    # Disabled commands
    {{- range $cmds }}
    rename-command {{ . }} ""
    {{- end }}
    {{- end }}
    {{- if .Values.config.customConfig }}
    # Custom configuration
    {{ .Values.config.customConfig | nindent 4 }}
    {{- end }}
